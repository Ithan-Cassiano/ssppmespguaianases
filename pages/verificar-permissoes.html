<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Permiss√µes - PMESP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e3a8a;
            margin-bottom: 30px;
        }
        .info-box {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #1e3a8a;
        }
        .success-box {
            background: #d1fae5;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #10b981;
        }
        .error-box {
            background: #fee2e2;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
        }
        .warning-box {
            background: #fef3c7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #f59e0b;
        }
        button {
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1e40af;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-ok {
            background: #10b981;
            color: white;
        }
        .status-error {
            background: #ef4444;
            color: white;
        }
        .status-warning {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verificador de Permiss√µes - Admin</h1>
        
        <button onclick="verificarTudo()">Verificar Tudo</button>
        <button onclick="corrigirAdmin()" class="btn-danger">Corrigir Admin</button>
        <button onclick="limparTudo()" class="btn-danger">Limpar Tudo e Recriar</button>
        <button onclick="window.location.href='admin.html'">Ir para Admin</button>
        
        <div id="resultado"></div>
    </div>
    
    <script src="../scripts/auth.js"></script>
    <script>
        function verificarTudo() {
            const resultado = document.getElementById('resultado');
            let html = '';
            
            // 1. Verificar localStorage
            html += '<div class="info-box"><h3>1. Verificando localStorage</h3>';
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const currentUser = localStorage.getItem('currentUser');
                
                html += `<p><strong>Usu√°rios no localStorage:</strong> ${Object.keys(users).length}</p>`;
                html += `<p><strong>Usu√°rio logado:</strong> ${currentUser ? 'Sim' : 'N√£o'}</p>`;
                
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    html += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
                }
            } catch (e) {
                html += `<div class="error-box">Erro ao ler localStorage: ${e.message}</div>`;
            }
            html += '</div>';
            
            // 2. Verificar usu√°rio admin
            html += '<div class="info-box"><h3>2. Verificando Usu√°rio Admin</h3>';
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const admin = users['admin'];
                
                if (!admin) {
                    html += '<div class="error-box"><strong>‚ùå ERRO:</strong> Usu√°rio admin N√ÉO existe!</div>';
                } else {
                    html += '<div class="success-box"><strong>‚úì</strong> Usu√°rio admin existe</div>';
                    html += `<p><strong>Username:</strong> ${admin.username}</p>`;
                    html += `<p><strong>Email:</strong> ${admin.email || 'N/A'}</p>`;
                    html += `<p><strong>Role:</strong> <span class="status ${admin.role === 'admin' ? 'status-ok' : 'status-error'}">${admin.role || 'N√ÉO DEFINIDO'}</span></p>`;
                    html += `<p><strong>Senha:</strong> ${admin.password ? '***' : 'N√ÉO DEFINIDA'}</p>`;
                    
                    if (admin.role !== 'admin') {
                        html += '<div class="error-box"><strong>‚ùå ERRO CR√çTICO:</strong> O role do admin n√£o √© "admin"! √â: "' + admin.role + '"</div>';
                    }
                    
                    if (!admin.password || admin.password !== 'r0@t') {
                        html += '<div class="warning-box"><strong>‚ö†Ô∏è AVISO:</strong> A senha do admin n√£o est√° correta ou n√£o est√° definida!</div>';
                    }
                    
                    html += '<pre>' + JSON.stringify(admin, null, 2) + '</pre>';
                }
            } catch (e) {
                html += `<div class="error-box">Erro ao verificar admin: ${e.message}</div>`;
            }
            html += '</div>';
            
            // 3. Verificar usu√°rio logado
            html += '<div class="info-box"><h3>3. Verificando Usu√°rio Logado</h3>';
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (!currentUser) {
                    html += '<div class="warning-box"><strong>‚ö†Ô∏è AVISO:</strong> Nenhum usu√°rio est√° logado!</div>';
                    html += '<p>Voc√™ precisa fazer login primeiro.</p>';
                } else {
                    const user = JSON.parse(currentUser);
                    html += '<div class="success-box"><strong>‚úì</strong> Usu√°rio logado</div>';
                    html += `<p><strong>Username:</strong> ${user.username}</p>`;
                    html += `<p><strong>Role:</strong> <span class="status ${user.role === 'admin' ? 'status-ok' : 'status-error'}">${user.role || 'N√ÉO DEFINIDO'}</span></p>`;
                    
                    if (user.role !== 'admin') {
                        html += '<div class="error-box"><strong>‚ùå ERRO:</strong> O usu√°rio logado N√ÉO √© admin! Role: "' + user.role + '"</div>';
                    }
                    
                    html += '<pre>' + JSON.stringify(user, null, 2) + '</pre>';
                }
            } catch (e) {
                html += `<div class="error-box">Erro ao verificar usu√°rio logado: ${e.message}</div>`;
            }
            html += '</div>';
            
            // 4. Verificar auth.js
            html += '<div class="info-box"><h3>4. Verificando Sistema de Autentica√ß√£o</h3>';
            try {
                if (typeof auth === 'undefined') {
                    html += '<div class="error-box"><strong>‚ùå ERRO:</strong> auth.js n√£o foi carregado!</div>';
                } else {
                    html += '<div class="success-box"><strong>‚úì</strong> auth.js carregado</div>';
                    
                    const isAdmin = auth.isAdmin();
                    html += `<p><strong>auth.isAdmin():</strong> <span class="status ${isAdmin ? 'status-ok' : 'status-error'}">${isAdmin ? 'SIM' : 'N√ÉO'}</span></p>`;
                    
                    const currentUser = auth.getCurrentUser();
                    if (currentUser) {
                        html += `<p><strong>auth.getCurrentUser():</strong></p>`;
                        html += '<pre>' + JSON.stringify(currentUser, null, 2) + '</pre>';
                    } else {
                        html += '<p><strong>auth.getCurrentUser():</strong> null (nenhum usu√°rio logado)</p>';
                    }
                }
            } catch (e) {
                html += `<div class="error-box">Erro ao verificar auth: ${e.message}</div>`;
            }
            html += '</div>';
            
            // 5. Resumo e Recomenda√ß√µes
            html += '<div class="info-box"><h3>5. Resumo e Recomenda√ß√µes</h3>';
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const admin = users['admin'];
                const currentUser = localStorage.getItem('currentUser');
                const user = currentUser ? JSON.parse(currentUser) : null;
                
                let problemas = [];
                let solucoes = [];
                
                if (!admin) {
                    problemas.push('Usu√°rio admin n√£o existe');
                    solucoes.push('Clique em "Corrigir Admin" para criar o usu√°rio admin');
                } else if (admin.role !== 'admin') {
                    problemas.push('Usu√°rio admin n√£o tem role "admin"');
                    solucoes.push('Clique em "Corrigir Admin" para corrigir o role');
                }
                
                if (!currentUser) {
                    problemas.push('Nenhum usu√°rio est√° logado');
                    solucoes.push('Fa√ßa login com usu√°rio: admin, senha: r0@t');
                } else if (user && user.role !== 'admin') {
                    problemas.push('Usu√°rio logado n√£o √© admin');
                    solucoes.push('Fa√ßa logout e login novamente com o usu√°rio admin');
                }
                
                if (typeof auth === 'undefined') {
                    problemas.push('auth.js n√£o foi carregado');
                    solucoes.push('Verifique se o arquivo auth.js existe e est√° acess√≠vel');
                } else if (!auth.isAdmin()) {
                    problemas.push('auth.isAdmin() retorna false');
                    solucoes.push('Corrija o usu√°rio admin e fa√ßa login novamente');
                }
                
                if (problemas.length === 0) {
                    html += '<div class="success-box"><strong>‚úì Tudo OK!</strong> Seu usu√°rio admin est√° configurado corretamente.</div>';
                } else {
                    html += '<div class="error-box"><strong>‚ùå Problemas Encontrados:</strong><ul>';
                    problemas.forEach(p => html += `<li>${p}</li>`);
                    html += '</ul></div>';
                    
                    html += '<div class="warning-box"><strong>üí° Solu√ß√µes:</strong><ul>';
                    solucoes.forEach(s => html += `<li>${s}</li>`);
                    html += '</ul></div>';
                }
            } catch (e) {
                html += `<div class="error-box">Erro ao gerar resumo: ${e.message}</div>`;
            }
            html += '</div>';
            
            resultado.innerHTML = html;
        }
        
        function corrigirAdmin() {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                
                // Garantir que admin existe e tem permiss√µes corretas
                users['admin'] = {
                    username: 'admin',
                    password: 'r0@t',
                    email: 'admin@pmesp.gov.br',
                    role: 'admin',
                    createdAt: users['admin']?.createdAt || new Date().toISOString()
                };
                
                localStorage.setItem('users', JSON.stringify(users));
                
                // Atualizar usu√°rio logado se for admin
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    if (user.username === 'admin') {
                        user.role = 'admin';
                        localStorage.setItem('currentUser', JSON.stringify(user));
                    }
                }
                
                alert('‚úì Admin corrigido com sucesso!\n\nUsu√°rio: admin\nSenha: r0@t\nRole: admin\n\nRecarregue a p√°gina e fa√ßa login novamente.');
                verificarTudo();
            } catch (error) {
                alert('Erro ao corrigir admin: ' + error.message);
            }
        }
        
        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar TUDO? Isso apagar√° todos os usu√°rios, not√≠cias, atividades e concursos!')) {
                localStorage.clear();
                
                // Recriar admin
                const defaultUsers = {
                    'admin': {
                        username: 'admin',
                        password: 'r0@t',
                        email: 'admin@pmesp.gov.br',
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    }
                };
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                
                alert('‚úì Tudo limpo e admin recriado!\n\nUsu√°rio: admin\nSenha: r0@t\n\nFa√ßa login novamente.');
                verificarTudo();
            }
        }
        
        // Verificar automaticamente ao carregar
        window.onload = function() {
            verificarTudo();
        };
    </script>
</body>
</html>

